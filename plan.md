# Plan: Host Moltbot With Its Original UI (FARM Stack Wrapper)

## Objectives
- Provide a thin wrapper that:
  1) Collects provider choice (Anthropic/OpenAI) and API key
  2) Auto-generates a gateway token
  3) Installs Node.js 22+ and Moltbot
  4) Starts `moltbot gateway --port 18789`
  5) Proxies the real Moltbot Control UI under our app domain
- Preserve Moltbot’s original Control UI (no custom UI beyond setup screen)
- Ensure stable access via our app URL with WebSocket support

## Core Workflow (Most failure-prone)
- Launch Moltbot gateway locally and expose it through our backend as a reverse proxy that supports HTTP + WebSocket
- Configure Moltbot UI `gateway.controlUi.basePath` = `/api/moltbot` so assets and WS resolve under backend prefix

## Integrations (to confirm with playbooks)
- Node.js 22+ installation (NodeSource script)
- Moltbot CLI install via `npm install -g moltbot@latest`

---

## Phase 1: Core POC (Required: WebSockets + external runtime)
Goal: Prove end-to-end that we can run Moltbot locally and serve its original Control UI through our backend path with WS working.

Scope:
1) Install Node.js 22+ (verify `node -v` >= 22)
2) Install Moltbot globally (`npm install -g moltbot@latest`, verify `moltbot --version`)
3) Generate gateway token and write `~/.clawdbot/moltbot.json`:
   - `gateway.controlUi.basePath: "/api/moltbot"`
   - `gateway.auth.mode: "token"`, `gateway.auth.token: <auto-generated>`
4) Start `moltbot gateway --port 18789 --bind 127.0.0.1` with chosen provider API key in env
5) Implement backend reverse proxy endpoints:
   - HTTP proxy: `GET/POST/etc /api/moltbot/{path:path} -> http://127.0.0.1:18789/{path}`
   - WS proxy: `/api/moltbot` and `/api/moltbot/{path:path}` -> `ws://127.0.0.1:18789[/path]`
6) POC verification script (single Python file):
   - Checks Node version, Moltbot installed
   - Spawns Moltbot gateway (env key mocked or test key var)
   - Polls `GET /api/moltbot/` (via backend) for 200/HTML
   - (Optional) Quick WS handshake proxy test

User Stories (Phase 1):
1) As a deployer, I can verify Node 22+ is present via a script
2) As a deployer, I can install Moltbot and confirm `moltbot --version`
3) As a user, I can open `/api/moltbot/` on our domain and see Moltbot UI load assets
4) As a user, the Moltbot UI connects over WS (no console errors)
5) As a developer, I can restart the gateway and the proxy continues to function

Exit Criteria (Phase 1):
- `GET /api/moltbot/` returns the actual Moltbot Control UI (HTML + assets)
- WebSocket connection succeeds through proxy (no runtime errors)

---

## Phase 2: Main App Development (Complete MVP)
Backend (FastAPI):
- POST `/api/molt/start` { provider: "anthropic"|"openai", apiKey: string }
  - Ensure Node 22+ (install if needed)
  - Install Moltbot if missing/update if outdated
  - Generate token; write/update `~/.clawdbot/moltbot.json` with basePath `/api/moltbot` and auth token
  - Start Moltbot gateway (bg process, bind 127.0.0.1:18789) with env: `ANTHROPIC_API_KEY` or `OPENAI_API_KEY`
  - Return `{ ok, uiUrl: "/api/moltbot/", token }`
- GET `/api/molt/status` -> `{ running, pid?, version?, nodeVersion? }`
- POST `/api/molt/stop` -> graceful stop (if needed)
- Reverse proxy endpoints implemented in Phase 1 reused as-is
- Dependencies: `httpx`, `websockets`, (optional) `psutil`

Frontend (React):
- Single Setup page:
  - Provider select (Anthropic/OpenAI)
  - API key input (masked)
  - Start button with loading state
  - On success: hard redirect to `/api/moltbot/`
  - Basic error handling and retry
  - data-testid attributes for testing

Process Management:
- Track spawned gateway process (singleton)
- Reuse existing process if already started

Security/Config:
- Minimal as requested; token-based gateway auth set in Moltbot config
- Do not persist user API keys to DB; supply as process env only

Testing & QA:
- Run Testing Agent for:
  - Start flow (Anthropic + OpenAI paths)
  - Status endpoint
  - UI loads via `/api/moltbot/` (skip interactive QR flows)
  - Error surfaces on missing API key
  - Repeated starts reuse running process

User Stories (Phase 2):
1) As a user, I can pick Anthropic or OpenAI, enter my key, and start Moltbot
2) As a user, I see a loading indicator until Moltbot is ready
3) As a user, I am redirected to the real Moltbot Control UI under `/api/moltbot/`
4) As a user, refreshing the page keeps the UI working without re-setup
5) As an admin, I can query `/api/molt/status` to confirm it’s running

Exit Criteria (Phase 2):
- End-to-end flow works from setup → UI visible and usable
- Both providers supported (env var set correctly)
- Testing agent run passes all listed scenarios

---

## Implementation Steps (High-Level)
1) Use integration playbook to confirm Node + Moltbot installation commands
2) Implement POC test script and reverse proxy in backend; run and fix until UI + WS load through `/api/moltbot/`
3) Build backend start/status/stop endpoints and process manager
4) Build minimal React setup page and redirect
5) Comprehensive testing with testing agent and logs review

## Status: COMPLETED ✅

### Phase 1: POC - COMPLETED
- ✅ Installed Node.js 22.22.0
- ✅ Installed Moltbot (clawdbot) 2026.1.24-3 via official installer
- ✅ Verified gateway can start and serve Control UI on port 18789
- ✅ Implemented HTTP reverse proxy for Moltbot UI at /api/moltbot/ui/
- ✅ Implemented WebSocket proxy for Moltbot at /api/moltbot/ws

### Phase 2: Main App - COMPLETED
- ✅ Built FastAPI backend with start/status/stop endpoints
- ✅ Built React setup page with provider selection (Anthropic/OpenAI)
- ✅ Dark theme matching Moltbot aesthetic (#FF4500 accent)
- ✅ API key input with show/hide toggle
- ✅ Loading states and progress indicator
- ✅ Error handling and validation
- ✅ Status check on page load
- ✅ Redirect to Moltbot Control UI after successful start

### Testing: PASSED 100%
- Backend: All endpoints working correctly
- Frontend: All UI features working correctly
- Integration: Complete flow from setup to Control UI

## Success Criteria
- From the preview URL, a user can:
  - Choose provider, enter API key, click Start
  - Be redirected to `/api/moltbot/` and see the official Moltbot Control UI
  - UI assets and WebSocket function correctly via proxy
